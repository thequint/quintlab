!function(){"use strict";var a=!1;if("undefined"!=typeof process&&!process.browser){a=!0;var b=require("request".trim())}var c=!1,d=!1;try{var e=new XMLHttpRequest;"undefined"!=typeof e.withCredentials?c=!0:"XDomainRequest"in window&&(c=!0,d=!0)}catch(a){}var f=Array.prototype.indexOf,g=function(a,b){var c=0,d=a.length;if(f&&a.indexOf===f)return a.indexOf(b);for(;c<d;c++)if(a[c]===b)return c;return-1},h=function(b){return this&&this instanceof h?("string"==typeof b&&(b={key:b}),this.callback=b.callback,this.wanted=b.wanted||[],this.key=b.key,this.simpleSheet=!!b.simpleSheet,this.parseNumbers=!!b.parseNumbers,this.wait=!!b.wait,this.reverse=!!b.reverse,this.postProcess=b.postProcess,this.debug=!!b.debug,this.query=b.query||"",this.orderby=b.orderby,this.endpoint=b.endpoint||"https://spreadsheets.google.com",this.singleton=!!b.singleton,this.simpleUrl=!(!b.simpleUrl&&!b.simple_url),this.callbackContext=b.callbackContext,this.prettyColumnNames="undefined"==typeof b.prettyColumnNames?!b.proxy:b.prettyColumnNames,"undefined"!=typeof b.proxy&&(this.endpoint=b.proxy.replace(/\/$/,""),this.simpleUrl=!0,this.singleton=!0,c=!1),this.parameterize=b.parameterize||!1,this.singleton&&("undefined"!=typeof h.singleton&&this.log("WARNING! Tabletop singleton already defined"),h.singleton=this),/key=/.test(this.key)&&(this.log("You passed an old Google Docs url as the key! Attempting to parse."),this.key=this.key.match("key=(.*?)(&|#|$)")[1]),/pubhtml/.test(this.key)&&(this.log("You passed a new Google Spreadsheets url as the key! Attempting to parse."),this.key=this.key.match("d\\/(.*?)\\/pubhtml")[1]),/spreadsheets\/d/.test(this.key)&&(this.log("You passed the most recent version of Google Spreadsheets url as the key! Attempting to parse."),this.key=this.key.match("d\\/(.*?)/")[1]),this.key?(this.log("Initializing with key "+this.key),this.models={},this.modelNames=[],this.model_names=this.modelNames,this.baseJsonPath="/feeds/worksheets/"+this.key+"/public/basic?alt=",a||c?this.baseJsonPath+="json":this.baseJsonPath+="json-in-script",void(this.wait||this.fetch())):void this.log("You need to pass Tabletop a key!")):new h(b)};h.callbacks={},h.init=function(a){return new h(a)},h.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")},h.prototype={fetch:function(a){"undefined"!=typeof a&&(this.callback=a),this.requestData(this.baseJsonPath,this.loadSheets)},requestData:function(b,e){if(this.log("Requesting",b),a)this.serverSideFetch(b,e);else{var f=this.endpoint.split("//").shift()||"http";!c||d&&f!==location.protocol?this.injectScript(b,e):this.xhrFetch(b,e)}},xhrFetch:function(a,b){var c=d?new XDomainRequest:new XMLHttpRequest;c.open("GET",this.endpoint+a);var e=this;c.onload=function(){var a;try{a=JSON.parse(c.responseText)}catch(a){console.error(a)}b.call(e,a)},c.send()},injectScript:function(a,b){var d,c=document.createElement("script");if(this.singleton)b===this.loadSheets?d="Tabletop.singleton.loadSheets":b===this.loadSheet&&(d="Tabletop.singleton.loadSheet");else{var e=this;d="tt"+ +new Date+Math.floor(1e5*Math.random()),h.callbacks[d]=function(){var a=Array.prototype.slice.call(arguments,0);b.apply(e,a),c.parentNode.removeChild(c),delete h.callbacks[d]},d="Tabletop.callbacks."+d}var f=a+"&callback="+d;this.simpleUrl?a.indexOf("/list/")!==-1?c.src=this.endpoint+"/"+this.key+"-"+a.split("/")[4]:c.src=this.endpoint+"/"+this.key:c.src=this.endpoint+f,this.parameterize&&(c.src=this.parameterize+encodeURIComponent(c.src)),this.log("Injecting",c.src),document.getElementsByTagName("script")[0].parentNode.appendChild(c)},serverSideFetch:function(a,c){var d=this;this.log("Fetching",this.endpoint+a),b({url:this.endpoint+a,json:!0},function(a,b,e){return a?console.error(a):void c.call(d,e)})},isWanted:function(a){return 0===this.wanted.length||g(this.wanted,a)!==-1},data:function(){if(0!==this.modelNames.length)return this.simpleSheet?(this.modelNames.length>1&&this.debug&&this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong."),this.models[this.modelNames[0]].all()):this.models},addWanted:function(a){g(this.wanted,a)===-1&&this.wanted.push(a)},loadSheets:function(b){var d,e,f=[];for(this.googleSheetName=b.feed.title.$t,this.foundSheetNames=[],d=0,e=b.feed.entry.length;d<e;d++)if(this.foundSheetNames.push(b.feed.entry[d].title.$t),this.isWanted(b.feed.entry[d].content.$t)){var g=b.feed.entry[d].link.length-1,h=b.feed.entry[d].link[g].href.split("/").pop(),i="/feeds/list/"+this.key+"/"+h+"/public/values?alt=";i+=a||c?"json":"json-in-script",this.query&&(i+="&tq="+this.query),this.orderby&&(i+="&orderby=column:"+this.orderby.toLowerCase()),this.reverse&&(i+="&reverse=true"),f.push(i)}for(this.sheetsToLoad=f.length,d=0,e=f.length;d<e;d++)this.requestData(f[d],this.loadSheet)},sheets:function(a){return"undefined"==typeof a?this.models:"undefined"==typeof this.models[a]?void 0:this.models[a]},sheetReady:function(a){this.models[a.name]=a,g(this.modelNames,a.name)===-1&&this.modelNames.push(a.name),this.sheetsToLoad--,0===this.sheetsToLoad&&this.doCallback()},loadSheet:function(a){var b=this;new h.Model({data:a,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this,prettyColumnNames:this.prettyColumnNames,onReady:function(){b.sheetReady(this)}})},doCallback:function(){0===this.sheetsToLoad&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(){this.debug&&"undefined"!=typeof console&&"undefined"!=typeof console.log&&Function.prototype.apply.apply(console.log,[console,arguments])}},h.Model=function(a){var b,c,d,e;if(this.columnNames=[],this.column_names=this.columnNames,this.name=a.data.feed.title.$t,this.tabletop=a.tabletop,this.elements=[],this.onReady=a.onReady,this.raw=a.data,"undefined"==typeof a.data.feed.entry)return a.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers"),this.originalColumns=[],this.elements=[],void this.onReady.call(this);for(var f in a.data.feed.entry[0])/^gsx/.test(f)&&this.columnNames.push(f.replace("gsx$",""));for(this.originalColumns=this.columnNames,this.original_columns=this.originalColumns,b=0,d=a.data.feed.entry.length;b<d;b++){var g=a.data.feed.entry[b],h={};for(c=0,e=this.columnNames.length;c<e;c++){var i=g["gsx$"+this.columnNames[c]];"undefined"!=typeof i?a.parseNumbers&&""!==i.$t&&!isNaN(i.$t)?h[this.columnNames[c]]=+i.$t:h[this.columnNames[c]]=i.$t:h[this.columnNames[c]]=""}void 0===h.rowNumber&&(h.rowNumber=b+1),a.postProcess&&a.postProcess(h),this.elements.push(h)}a.prettyColumnNames?this.fetchPrettyColumns():this.onReady.call(this)},h.Model.prototype={all:function(){return this.elements},fetchPrettyColumns:function(){if(!this.raw.feed.link[3])return this.ready();var a=this.raw.feed.link[3].href.replace("/feeds/list/","/feeds/cells/").replace("https://spreadsheets.google.com",""),b=this;this.tabletop.requestData(a,function(a){b.loadPrettyColumns(a)})},ready:function(){this.onReady.call(this)},loadPrettyColumns:function(a){for(var b={},c=this.columnNames,d=0,e=c.length;d<e;d++)"undefined"!=typeof a.feed.entry[d].content.$t?b[c[d]]=a.feed.entry[d].content.$t:b[c[d]]=c[d];this.prettyColumns=b,this.pretty_columns=this.prettyColumns,this.prettifyElements(),this.ready()},prettifyElements:function(){var c,d,e,f,a=[],b=[];for(d=0,f=this.columnNames.length;d<f;d++)b.push(this.prettyColumns[this.columnNames[d]]);for(c=0,e=this.elements.length;c<e;c++){var g={};for(d=0,f=this.columnNames.length;d<f;d++){var h=this.prettyColumns[this.columnNames[d]];g[h]=this.elements[c][this.columnNames[d]]}a.push(g)}this.elements=a,this.columnNames=b},toArray:function(){var b,c,d,e,a=[];for(b=0,d=this.elements.length;b<d;b++){var f=[];for(c=0,e=this.columnNames.length;c<e;c++)f.push(this.elements[b][this.columnNames[c]]);a.push(f)}return a}},"undefined"!=typeof module&&module.exports?module.exports=h:"function"==typeof define&&define.amd?define(function(){return h}):window.Tabletop=h}();